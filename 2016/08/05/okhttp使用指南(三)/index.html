<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>OkHttp 使用指南(四)--Recipes | WinterFell</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="OkHttp 使用指南(四)–Recipes
手打翻译原文，若转载本文请注明出处
&amp;emsp;我们使用 OkHttp 写了很多方法例子来说明解决使用过程中遇到的常见的问题。通过阅读这些例子这些组件是怎么在一起工作的。粘贴复制这些例子是自由免费的，因为这就是这些例子的用途。">
<meta property="og:type" content="article">
<meta property="og:title" content="OkHttp 使用指南(四)--Recipes">
<meta property="og:url" content="http://nortonahu.github.io/2016/08/05/okhttp使用指南(三)/index.html">
<meta property="og:site_name" content="WinterFell">
<meta property="og:description" content="OkHttp 使用指南(四)–Recipes
手打翻译原文，若转载本文请注明出处
&amp;emsp;我们使用 OkHttp 写了很多方法例子来说明解决使用过程中遇到的常见的问题。通过阅读这些例子这些组件是怎么在一起工作的。粘贴复制这些例子是自由免费的，因为这就是这些例子的用途。">
<meta property="og:image" content="http://nortonahu.github.io/thumbnails/okhttp_recipes.jpg">
<meta property="og:updated_time" content="2016-08-04T16:02:25.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OkHttp 使用指南(四)--Recipes">
<meta name="twitter:description" content="OkHttp 使用指南(四)–Recipes
手打翻译原文，若转载本文请注明出处
&amp;emsp;我们使用 OkHttp 写了很多方法例子来说明解决使用过程中遇到的常见的问题。通过阅读这些例子这些组件是怎么在一起工作的。粘贴复制这些例子是自由免费的，因为这就是这些例子的用途。">
<meta name="twitter:image" content="http://nortonahu.github.io/thumbnails/okhttp_recipes.jpg">
  
    <link rel="alternative" href="/atom.xml" title="WinterFell" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="/img/header_image.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Hong Yu</a></h1>
		</hgroup>

		
		<p class="header-subtitle">Winter Is Coming</p>
		

		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives">所有文章</a></li>
				        
							<li><a href="/categories/技术教程">技术教程</a></li>
				        
							<li><a href="/categories/杂谈">杂谈</a></li>
				        
							<li><a href="/about/index.html">关于</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/NortonAhu" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/yuhongpc/profile?rightmod=1&wvr=6&mod=personinfo" title="weibo">weibo</a>
					        
								<a class="twitter" target="_blank" href="https://twitter.com/HongYuAhuCN" title="twitter">twitter</a>
					        
						</div>
					</nav>
				</section>
				
				
				
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Hong Yu</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="/img/header_image.jpg" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">Hong Yu</h1>
			</hgroup>
			
			<p class="header-subtitle">Winter Is Coming</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives">所有文章</a></li>
		        
					<li><a href="/categories/技术教程">技术教程</a></li>
		        
					<li><a href="/categories/杂谈">杂谈</a></li>
		        
					<li><a href="/about/index.html">关于</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/NortonAhu" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/yuhongpc/profile?rightmod=1&wvr=6&mod=personinfo" title="weibo">weibo</a>
			        
						<a class="twitter" target="_blank" href="https://twitter.com/HongYuAhuCN" title="twitter">twitter</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

      <div class="body-wrap"><article id="post-okhttp使用指南(三)" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/08/05/okhttp使用指南(三)/" class="article-date">
  	<time datetime="2016-08-04T16:02:25.000Z" itemprop="datePublished">2016-08-05</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      OkHttp 使用指南(四)--Recipes
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/OkHttp/">OkHttp</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Square/">Square</a></li></ul>
	</div>

        
	<div class="article-category tagcloud">
	<a class="article-category-link" href="/categories/技术教程/">技术教程</a>
	</div>


        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="OkHttp-使用指南-四-–Recipes"><a href="#OkHttp-使用指南-四-–Recipes" class="headerlink" title="OkHttp 使用指南(四)–Recipes"></a>OkHttp 使用指南(四)–Recipes</h1><p><img src="/thumbnails/okhttp_recipes.jpg" alt=""></p>
<p>手打翻译<a href="https://github.com/square/okhttp/wiki/Recipes" target="_blank" rel="external">原文</a>，若转载本文请注明出处</p>
<p>&emsp;我们使用 OkHttp 写了很多方法例子来说明解决使用过程中遇到的常见的问题。通过阅读这些例子这些组件是怎么在一起工作的。粘贴复制这些例子是自由免费的，因为这就是这些例子的用途。<br><a id="more"></a><br><strong>Synchronous Get（同步 GET）</strong><br>&emsp;下载一个文件，以字符串的形式打印出他的头部信息，打印出响应数据体信息。<br>&emsp; <em>String()</em> 方法作为一些小文件的响应数据体是非常方便和高效的。但是如果针对一些大文件的下载（大于 1MB 文件），尽量避免使用 <em>String()</em> 方法因为他会将整个文本加载到内存中。针对这种例子优先选择的解决方案是将数据体作为一个数据流来处理。<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> final OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"><span class="keyword">public</span> void run() throws Exception &#123;</div><div class="line">  <span class="built_in">Request</span> <span class="built_in">request</span> = <span class="keyword">new</span> <span class="built_in">Request</span>.Builder()</div><div class="line">      .url(<span class="string">"http://publicobject.com/helloworld.txt"</span>)</div><div class="line">      .build();</div><div class="line"></div><div class="line">  <span class="built_in">Response</span> <span class="built_in">response</span> = client.newCall(<span class="built_in">request</span>).<span class="keyword">execute</span>();</div><div class="line">  <span class="keyword">if</span> (!<span class="built_in">response</span>.isSuccessful()) throw <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + <span class="built_in">response</span>);</div><div class="line"></div><div class="line">  Headers responseHeaders = <span class="built_in">response</span>.headers();</div><div class="line">  <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; responseHeaders.size(); i++) &#123;</div><div class="line">    System.out.println(responseHeaders.name(i) + <span class="string">": "</span> + responseHeaders.value(i));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  System.out.println(<span class="built_in">response</span>.body().<span class="built_in">string</span>());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Asynchronous Get（异步 GET）</strong><br>&emsp;在工作线程中进行下载任务，并且在响应到达的时候采用回调的方式通知。这个回调会等待响应信息头准备好之后发送，读取这个响应头信息仍然会阻塞。目前的 OKHttp 不支持异步的 APIS 来接收处理部分的响应体。<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> final OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"><span class="keyword">public</span> void run() throws Exception &#123;</div><div class="line">  <span class="built_in">Request</span> <span class="built_in">request</span> = <span class="keyword">new</span> <span class="built_in">Request</span>.Builder()</div><div class="line">      .url(<span class="string">"http://publicobject.com/helloworld.txt"</span>)</div><div class="line">      .build();</div><div class="line"></div><div class="line">  client.newCall(<span class="built_in">request</span>).enqueue(<span class="keyword">new</span> Callback() &#123;</div><div class="line">    @Override <span class="keyword">public</span> void onFailure(<span class="built_in">Request</span> <span class="built_in">request</span>, IOException throwable) &#123;</div><div class="line">      throwable.printStackTrace();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    @Override <span class="keyword">public</span> void onResponse(<span class="built_in">Response</span> <span class="built_in">response</span>) throws IOException &#123;</div><div class="line">      <span class="keyword">if</span> (!<span class="built_in">response</span>.isSuccessful()) throw <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + <span class="built_in">response</span>);</div><div class="line"></div><div class="line">      Headers responseHeaders = <span class="built_in">response</span>.headers();</div><div class="line">      <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; responseHeaders.size(); i++) &#123;</div><div class="line">        System.out.println(responseHeaders.name(i) + <span class="string">": "</span> + responseHeaders.value(i));</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      System.out.println(<span class="built_in">response</span>.body().<span class="built_in">string</span>());</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Accessing Headers（访问头部）</strong><br>&emsp;典型的 HTTP 头部信息类似于 <em>Map<string, string=""></string,></em> :每一个属性都有一个值或者没有，但是某些信息头允许多个值信息，类似于  Guava <a href="http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/collect/Multimap.html" target="_blank" rel="external">Multimap</a>。例如，对于 Http 响应信息头部包含多个变量值是合法常见的。OkHttp APIs 计划所有这些情况兼容。<br>&emsp;使用 <em>header(name, value)</em> 方法来写唯一的请求头部信息。如果已经存在了一个值，在新的值添加前会移除掉当前值。使用 <em>addHeader(name, value)</em> 方法增加头部信息而不用移除之前已经录入的信息。<br>&emsp;通过 <em>header(name)</em> 读取响应头部信息,返回的是最新的值，通常情况下都会返回值，但是如果本来就没有的话会返回 null ，通过使用 <em>headers(name)</em> 来访问头部信息。<br>&emsp;通过 <em>headers</em> 类可以根据 index 来访问头部信息。<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> final OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"><span class="keyword">public</span> void run() throws Exception &#123;</div><div class="line">  <span class="built_in">Request</span> <span class="built_in">request</span> = <span class="keyword">new</span> <span class="built_in">Request</span>.Builder()</div><div class="line">      .url(<span class="string">"https://api.github.com/repos/square/okhttp/issues"</span>)</div><div class="line">      .header(<span class="string">"User-Agent"</span>, <span class="string">"OkHttp Headers.java"</span>)</div><div class="line">      .addHeader(<span class="string">"Accept"</span>, <span class="string">"application/json; q=0.5"</span>)</div><div class="line">      .addHeader(<span class="string">"Accept"</span>, <span class="string">"application/vnd.github.v3+json"</span>)</div><div class="line">      .build();</div><div class="line"></div><div class="line">  <span class="built_in">Response</span> <span class="built_in">response</span> = client.newCall(<span class="built_in">request</span>).<span class="keyword">execute</span>();</div><div class="line">  <span class="keyword">if</span> (!<span class="built_in">response</span>.isSuccessful()) throw <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + <span class="built_in">response</span>);</div><div class="line"></div><div class="line">  System.out.println(<span class="string">"Server: "</span> + <span class="built_in">response</span>.header(<span class="string">"Server"</span>));</div><div class="line">  System.out.println(<span class="string">"Date: "</span> + <span class="built_in">response</span>.header(<span class="string">"Date"</span>));</div><div class="line">  System.out.println(<span class="string">"Vary: "</span> + <span class="built_in">response</span>.headers(<span class="string">"Vary"</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Post a String（发送一个字符串数据）</strong><br>&emsp;使用 Http 以 Post 方式来发送一个请求到服务端，这个例子是发送一个 markdown 文件到服务端来渲染成一个 HTML，因为整个请求是同时在内存中的，在使用这个 Api 时尽量避免使用数据量较大。<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> static final MediaType MEDIA_TYPE_MARKDOWN</div><div class="line">      = MediaType.parse(<span class="string">"text/x-markdown; charset=utf-8"</span>);</div><div class="line"></div><div class="line">  <span class="keyword">private</span> final OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line">  <span class="keyword">public</span> void run() throws Exception &#123;</div><div class="line">    <span class="built_in">String</span> postBody = <span class="string">""</span></div><div class="line">        + <span class="string">"Releases\n"</span></div><div class="line">        + <span class="string">"--------\n"</span></div><div class="line">        + <span class="string">"\n"</span></div><div class="line">        + <span class="string">" * _1.0_ May 6, 2013\n"</span></div><div class="line">        + <span class="string">" * _1.1_ June 15, 2013\n"</span></div><div class="line">        + <span class="string">" * _1.2_ August 11, 2013\n"</span>;</div><div class="line"></div><div class="line">    <span class="built_in">Request</span> <span class="built_in">request</span> = <span class="keyword">new</span> <span class="built_in">Request</span>.Builder()</div><div class="line">        .url(<span class="string">"https://api.github.com/markdown/raw"</span>)</div><div class="line">        .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, postBody))</div><div class="line">        .build();</div><div class="line"></div><div class="line">    <span class="built_in">Response</span> <span class="built_in">response</span> = client.newCall(<span class="built_in">request</span>).<span class="keyword">execute</span>();</div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">response</span>.isSuccessful()) throw <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + <span class="built_in">response</span>);</div><div class="line"></div><div class="line">    System.out.println(<span class="built_in">response</span>.body().<span class="built_in">string</span>());</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p><strong>Post Streaming（Post 方式发送流式）</strong><br>&emsp;这里我们要说明的例子是使用流式的方式发送请求。请求数据体的内容已经产生并被写入。这个例子会将流直接写入到 <a href="https://github.com/square/okio" target="_blank" rel="external">Okio</a> 缓冲槽中。你的项目可能会喜欢使用 <em>OutputStream</em>，这个你可以从 <em>BufferedSink.outputStream()</em>获取到。<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType MEDIA_TYPE_MARKDOWN</div><div class="line">    = MediaType.parse(<span class="string">"text/x-markdown; charset=utf-8"</span>);</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">  RequestBody requestBody = <span class="keyword">new</span> RequestBody() &#123;</div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function">MediaType <span class="title">contentType</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">return</span> MEDIA_TYPE_MARKDOWN;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span> <span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(BufferedSink sink)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">      sink.writeUtf8(<span class="string">"Numbers\n"</span>);</div><div class="line">      sink.writeUtf8(<span class="string">"-------\n"</span>);</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt;= <span class="number">997</span>; i++) &#123;</div><div class="line">        sink.writeUtf8(String.format(<span class="string">" * %s = %s\n"</span>, i, factor(i)));</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="function">String <span class="title">factor</span><span class="params">(<span class="keyword">int</span> n)</span> </span>&#123;</div><div class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">2</span>; i &lt; n; i++) &#123;</div><div class="line">        <span class="keyword">int</span> x = n / i;</div><div class="line">        <span class="keyword">if</span> (x * i == n) <span class="keyword">return</span> factor(x) + <span class="string">" × "</span> + i;</div><div class="line">      &#125;</div><div class="line">      <span class="function"><span class="keyword">return</span> Integer.<span class="title">toString</span><span class="params">(n)</span></span>;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">      .url(<span class="string">"https://api.github.com/markdown/raw"</span>)</div><div class="line">      .post(requestBody)</div><div class="line">      .build();</div><div class="line"></div><div class="line">  Response response = client.newCall(request).execute();</div><div class="line">  <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</div><div class="line"></div><div class="line">  System.out.println(response.body().string());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Posting a File（发送一个文件）</strong><br>简单使用file作为请求的数据体<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType MEDIA_TYPE_MARKDOWN</div><div class="line">     = MediaType.parse(<span class="string">"text/x-markdown; charset=utf-8"</span>);</div><div class="line"></div><div class="line"> <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="keyword">void</span> run() <span class="keyword">throws</span> Exception &#123;</div><div class="line">   <span class="keyword">File</span> <span class="keyword">file</span> = <span class="keyword">new</span> <span class="keyword">File</span>(<span class="string">"README.md"</span>);</div><div class="line"></div><div class="line">   Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">       .url(<span class="string">"https://api.github.com/markdown/raw"</span>)</div><div class="line">       .post(RequestBody.create(MEDIA_TYPE_MARKDOWN, <span class="keyword">file</span>))</div><div class="line">       .build();</div><div class="line"></div><div class="line">   Response response = client.newCall(request).execute();</div><div class="line">   <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</div><div class="line"></div><div class="line">   System.out.<span class="keyword">println</span>(response.body().string());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p><strong>Posting form parameters （发送表单参数）</strong><br>&emsp;使用 <em>FormEncodingBuilder</em> 建立一个请求链接类似于 HTML <em><form></form></em> 标签。<br>键值对会被使用 HTML 响应表单编码规范来编码。<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> final OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"> <span class="keyword">public</span> void run() throws Exception &#123;</div><div class="line">   RequestBody formBody = <span class="keyword">new</span> FormEncodingBuilder()</div><div class="line">       .add(<span class="string">"search"</span>, <span class="string">"Jurassic Park"</span>)</div><div class="line">       .build();</div><div class="line">   <span class="built_in">Request</span> <span class="built_in">request</span> = <span class="keyword">new</span> <span class="built_in">Request</span>.Builder()</div><div class="line">       .url(<span class="string">"https://en.wikipedia.org/w/index.php"</span>)</div><div class="line">       .post(formBody)</div><div class="line">       .build();</div><div class="line"></div><div class="line">   <span class="built_in">Response</span> <span class="built_in">response</span> = client.newCall(<span class="built_in">request</span>).<span class="keyword">execute</span>();</div><div class="line">   <span class="keyword">if</span> (!<span class="built_in">response</span>.isSuccessful()) throw <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + <span class="built_in">response</span>);</div><div class="line"></div><div class="line">   System.out.println(<span class="built_in">response</span>.body().<span class="built_in">string</span>());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p><strong>Posting a multipart request（发送多块请求）</strong><br>&emsp;<em>MultipartBuilder</em> 用来组装复杂的 HTML 文件上传表单请求数据体。其中多块请求数据体中的每一部分又是独立的请求数据体，并且可以自己定义数据头，如果这样的话数据头需要被定义成数据体的一部分，比如说作为  <em>Content-Disposition</em> 如果是有效的数据体的话 <em>Content-Length</em> 和 <em>Content-Length</em> 会自动加上的。<br><figure class="highlight d"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String IMGUR_CLIENT_ID = <span class="string">"..."</span>;</div><div class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MediaType MEDIA_TYPE_PNG = MediaType.parse(<span class="string">"image/png"</span>);</div><div class="line"></div><div class="line"> <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="keyword">void</span> run() throws Exception &#123;</div><div class="line">   <span class="comment">// Use the imgur image upload API as documented at https://api.imgur.com/endpoints/image</span></div><div class="line">   RequestBody requestBody = <span class="keyword">new</span> MultipartBuilder()</div><div class="line">       .type(MultipartBuilder.FORM)</div><div class="line">       .addPart(</div><div class="line">           Headers.of(<span class="string">"Content-Disposition"</span>, <span class="string">"form-data; name=\"title\""</span>),</div><div class="line">           RequestBody.create(<span class="literal">null</span>, <span class="string">"Square Logo"</span>))</div><div class="line">       .addPart(</div><div class="line">           Headers.of(<span class="string">"Content-Disposition"</span>, <span class="string">"form-data; name=\"image\""</span>),</div><div class="line">           RequestBody.create(MEDIA_TYPE_PNG, <span class="keyword">new</span> File(<span class="string">"website/static/logo-square.png"</span>)))</div><div class="line">       .build();</div><div class="line"></div><div class="line">   Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">       .header(<span class="string">"Authorization"</span>, <span class="string">"Client-ID "</span> + IMGUR_CLIENT_ID)</div><div class="line">       .url(<span class="string">"https://api.imgur.com/3/image"</span>)</div><div class="line">       .post(requestBody)</div><div class="line">       .build();</div><div class="line"></div><div class="line">   Response response = client.newCall(request).execute();</div><div class="line">   <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</div><div class="line"></div><div class="line">   System.<span class="keyword">out</span>.println(response.<span class="keyword">body</span>().<span class="built_in">string</span>());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p><strong>Parse a JSON Response With Gson（通过 Gson 来解析 JSON 格式的响应信息）</strong></p>
<p>&emsp;<a href="http://code.google.com/p/google-gson/" target="_blank" rel="external">Gson</a> 是一种将 JSON 转变为 JAVA 对象非常方便的 API，这里我通过 Gson GitHub API 来解析对应 JSON 响应数据。<br>&emsp;需要注意的是 <em>ResponseBody.charStream()</em> 是使用相应信息的头部数据 <em>Content-Type</em> 来选择哪一种编码来解析响应的数据体。如果没有指定编码格式化默认使用的是 UTF-8 格式。<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> final OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line">  <span class="keyword">private</span> final Gson gson = <span class="keyword">new</span> Gson();</div><div class="line"></div><div class="line">  <span class="keyword">public</span> void run() throws Exception &#123;</div><div class="line">    <span class="built_in">Request</span> <span class="built_in">request</span> = <span class="keyword">new</span> <span class="built_in">Request</span>.Builder()</div><div class="line">        .url(<span class="string">"https://api.github.com/gists/c2a7c39532239ff261be"</span>)</div><div class="line">        .build();</div><div class="line">    <span class="built_in">Response</span> <span class="built_in">response</span> = client.newCall(<span class="built_in">request</span>).<span class="keyword">execute</span>();</div><div class="line">    <span class="keyword">if</span> (!<span class="built_in">response</span>.isSuccessful()) throw <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + <span class="built_in">response</span>);</div><div class="line"></div><div class="line">    Gist gist = gson.fromJson(<span class="built_in">response</span>.body().charStream(), Gist.<span class="keyword">class</span>);</div><div class="line">    <span class="keyword">for</span> (Map.Entry&lt;<span class="built_in">String</span>, GistFile&gt; entry : gist.files.entrySet()) &#123;</div><div class="line">      System.out.println(entry.getKey());</div><div class="line">      System.out.println(entry.getValue().content);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  static <span class="keyword">class</span> Gist &#123;</div><div class="line">    Map&lt;<span class="built_in">String</span>, GistFile&gt; files;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  static <span class="keyword">class</span> GistFile &#123;</div><div class="line">    <span class="built_in">String</span> content;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p><strong>Response Caching（响应缓存）</strong><br>&emsp;对于响应缓存，你需要的是指定一个用来读取和写入的缓存存储路径，并且你需要指定一个缓存文件的大小限制。这个缓存的路径应该是私有的，并且对于不收信任的应用不能读取缓存的内容。<br>&emsp;如果多个缓存同时访问同一个缓存地址的话会出现错误。大多数应用调用 <em>new OkHttpClient()</em> 一次，配置参数和缓存，在应用的其他使用它的实例对象进行操作。否则两个缓存对象会相互影响，混乱的响应缓可能会导致你的应用崩溃。<br>&emsp;响应缓存使用 HTTP headers 作为所有的配置信息。你可以在请求头部增加 <em>Cache-Control: max-stale=3600</em> 这样 OkHttpClient 就会执行这个设置。你的服务端会响应头部使用自己的缓存时间配置信息，例如 <em>Cache-Control: max-age=9600</em> 这些缓存头部会强行拉取 缓存响应，网络响应，网络响应会被刷新通过有条件的 GET 请求。<br><figure class="highlight arduino"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> final OkHttpClient client;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> CacheResponse(<span class="built_in">File</span> cacheDirectory) throws Exception &#123;</div><div class="line">    <span class="keyword">int</span> cacheSize = <span class="number">10</span> * <span class="number">1024</span> * <span class="number">1024</span>; <span class="comment">// 10 MiB</span></div><div class="line">    Cache cache = <span class="keyword">new</span> Cache(cacheDirectory, cacheSize);</div><div class="line"></div><div class="line">    client = <span class="keyword">new</span> OkHttpClient();</div><div class="line">    client.setCache(cache);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="built_in">run</span>() throws Exception &#123;</div><div class="line">    Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">        .url(<span class="string">"http://publicobject.com/helloworld.txt"</span>)</div><div class="line">        .build();</div><div class="line"></div><div class="line">    Response response1 = client.newCall(request).execute();</div><div class="line">    <span class="built_in">if</span> (!response1.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response1);</div><div class="line"></div><div class="line">    <span class="keyword">String</span> response1Body = response1.body().<span class="keyword">string</span>();</div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"Response 1 response:          "</span> + response1);</div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"Response 1 cache response:    "</span> + response1.cacheResponse());</div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"Response 1 network response:  "</span> + response1.networkResponse());</div><div class="line"></div><div class="line">    Response response2 = client.newCall(request).execute();</div><div class="line">    <span class="built_in">if</span> (!response2.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response2);</div><div class="line"></div><div class="line">    <span class="keyword">String</span> response2Body = response2.body().<span class="keyword">string</span>();</div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"Response 2 response:          "</span> + response2);</div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"Response 2 cache response:    "</span> + response2.cacheResponse());</div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"Response 2 network response:  "</span> + response2.networkResponse());</div><div class="line"></div><div class="line">    System.out.<span class="built_in">println</span>(<span class="string">"Response 2 equals Response 1? "</span> + response1Body.equals(response2Body));</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;响应不用缓存，可以使用 <em>CacheControl.FORCE_NETWORK</em>。响应不用网络，使用 <em>CacheControl.FORCE_CACHE</em>。但是要注意的是如果你选择使用缓存的话，响应需要使用网络的话。OkHttp 会返回 <em>504 Unsatisfiable Request</em> 响应。</p>
<p><strong>Canceling a Call（取消请求）</strong><br>&emsp;使用 <em>Call.cancel()</em> 立即停止正在执行的请求。如果一个线程正在执行请求或者接收一个响应的话，他会收到一个 <em>IOException</em>。可以使用这个方法来取消那些不在需要的网络请求一边节约网络。比如用户离开你的应用，无论你的同步还是异步的请求就可以被取消掉。<br>&emsp;你也可以通过使用 tag 来同时取消掉多个请求。在构建一个请求的时候通过使用 <em>RequestBuilder.tag(tag)</em> 给请求打一个标签。然后通过 <em>OkHttpClient.cancel(tag)</em> 取消所有使用这个 tag 的请求。<br><figure class="highlight d"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> ScheduledExecutorService executor = Executors.newScheduledThreadPool(<span class="number">1</span>);</div><div class="line">  <span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line">  <span class="keyword">public</span> <span class="keyword">void</span> run() throws Exception &#123;</div><div class="line">    Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">        .url(<span class="string">"http://httpbin.org/delay/2"</span>) <span class="comment">// This URL is served with a 2 second delay.</span></div><div class="line">        .build();</div><div class="line"></div><div class="line">    <span class="keyword">final</span> <span class="built_in">long</span> startNanos = System.nanoTime();</div><div class="line">    <span class="keyword">final</span> Call call = client.newCall(request);</div><div class="line"></div><div class="line">    <span class="comment">// Schedule a job to cancel the call in 1 second.</span></div><div class="line">    executor.schedule(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">      <span class="keyword">@Override</span> <span class="keyword">public</span> <span class="keyword">void</span> run() &#123;</div><div class="line">        System.<span class="keyword">out</span>.printf(<span class="string">"%.2f Canceling call.%n"</span>, (System.nanoTime() - startNanos) / <span class="number">1e9f</span>);</div><div class="line">        call.cancel();</div><div class="line">        System.<span class="keyword">out</span>.printf(<span class="string">"%.2f Canceled call.%n"</span>, (System.nanoTime() - startNanos) / <span class="number">1e9f</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;, <span class="number">1</span>, TimeUnit.SECONDS);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      System.<span class="keyword">out</span>.printf(<span class="string">"%.2f Executing call.%n"</span>, (System.nanoTime() - startNanos) / <span class="number">1e9f</span>);</div><div class="line">      Response response = call.execute();</div><div class="line">      System.<span class="keyword">out</span>.printf(<span class="string">"%.2f Call was expected to fail, but completed: %s%n"</span>,</div><div class="line">          (System.nanoTime() - startNanos) / <span class="number">1e9f</span>, response);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      System.<span class="keyword">out</span>.printf(<span class="string">"%.2f Call failed as expected: %s%n"</span>,</div><div class="line">          (System.nanoTime() - startNanos) / <span class="number">1e9f</span>, e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p><strong>Timeouts（超时）</strong><br>&emsp;使用超时机制来取消一个另一个端点不可达的状态。网络模块可以划分为客户端连接问题、服务端可用问题或者两者都有，OkHttp 支持连接 read 和 write 三个时间的响应。<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient <span class="keyword">client</span>;</div><div class="line"></div><div class="line"><span class="keyword">public</span> ConfigureTimeouts() throws Exception &#123;</div><div class="line">  <span class="keyword">client</span> = <span class="keyword">new</span> OkHttpClient();</div><div class="line">  <span class="keyword">client</span>.setConnectTimeout(<span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">  <span class="keyword">client</span>.setWriteTimeout(<span class="number">10</span>, TimeUnit.SECONDS);</div><div class="line">  <span class="keyword">client</span>.setReadTimeout(<span class="number">30</span>, TimeUnit.SECONDS);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="keyword">void</span> run() throws Exception &#123;</div><div class="line">  Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">      .url(<span class="string">"http://httpbin.org/delay/2"</span>) <span class="comment">// This URL is served with a 2 second delay.</span></div><div class="line">      .build();</div><div class="line"></div><div class="line">  Response response = <span class="keyword">client</span>.newCall(request).execute();</div><div class="line">  System.out.println(<span class="string">"Response completed: "</span> + response);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>Per-call Configuration（单次配置）</strong><br>&emsp;所有的 Http 客户端配置都是在 OkHttpClient 设置包括代理设置、超时和缓存。当你需要单次配置客户端的时候话可以 clone OkHttpClient 这个将会返回一个浅 copy 对象这样你就可以定制单独的客户端设置了。下面的例子你可以看到一个设置 500ms 的超时和一个 30000ms 超时时间。<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="keyword">void</span> run() <span class="keyword">throws</span> Exception &#123;</div><div class="line">   Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">       .url(<span class="string">"http://httpbin.org/delay/1"</span>) <span class="comment">// This URL is served with a 1 second delay.</span></div><div class="line">       .build();</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     OkHttpClient cloned = client.clone(); <span class="comment">// Clone to make a customized OkHttp for this request.</span></div><div class="line">     cloned.setReadTimeout(<span class="number">500</span>, TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line">     Response response = cloned.newCall(request).execute();</div><div class="line">     System.out.<span class="keyword">println</span>(<span class="string">"Response 1 succeeded: "</span> + response);</div><div class="line">   &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">     System.out.<span class="keyword">println</span>(<span class="string">"Response 1 failed: "</span> + e);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">try</span> &#123;</div><div class="line">     OkHttpClient cloned = client.clone(); <span class="comment">// Clone to make a customized OkHttp for this request.</span></div><div class="line">     cloned.setReadTimeout(<span class="number">3000</span>, TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line">     Response response = cloned.newCall(request).execute();</div><div class="line">     System.out.<span class="keyword">println</span>(<span class="string">"Response 2 succeeded: "</span> + response);</div><div class="line">   &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">     System.out.<span class="keyword">println</span>(<span class="string">"Response 2 failed: "</span> + e);</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p><strong>Handling authentication（处理证书）</strong><br>&emsp;OkHttp 可以自动重试非证书的请求，当一个请求的响应是 <em>401 Not Authorized</em> ，<em>Authenticator</em> 被要求提供证书验证，需要重新执行一个包含证书的请求。如果没有证书可以提供会返回空来跳过重试。使用 <em>Response.challenges()</em> 获得一个模式和领域来针对所有的证书验证，当面对的是一个 <em>Basic</em> 验证。使用 <em>Credentials.basic(username, password)</em> 来编码请求信息。<br><figure class="highlight d"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">final</span> OkHttpClient client = <span class="keyword">new</span> OkHttpClient();</div><div class="line"></div><div class="line"> <span class="keyword">public</span> <span class="keyword">void</span> run() throws Exception &#123;</div><div class="line">   client.setAuthenticator(<span class="keyword">new</span> Authenticator() &#123;</div><div class="line">     <span class="keyword">@Override</span> <span class="keyword">public</span> Request authenticate(Proxy proxy, Response response) &#123;</div><div class="line">       System.<span class="keyword">out</span>.println(<span class="string">"Authenticating for response: "</span> + response);</div><div class="line">       System.<span class="keyword">out</span>.println(<span class="string">"Challenges: "</span> + response.challenges());</div><div class="line">       String credential = Credentials.basic(<span class="string">"jesse"</span>, <span class="string">"password1"</span>);</div><div class="line">       <span class="keyword">return</span> response.request().newBuilder()</div><div class="line">           .header(<span class="string">"Authorization"</span>, credential)</div><div class="line">           .build();</div><div class="line">     &#125;</div><div class="line"></div><div class="line">     <span class="keyword">@Override</span> <span class="keyword">public</span> Request authenticateProxy(Proxy proxy, Response response) &#123;</div><div class="line">       <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// Null indicates no attempt to authenticate.</span></div><div class="line">     &#125;</div><div class="line">   &#125;);</div><div class="line"></div><div class="line">   Request request = <span class="keyword">new</span> Request.Builder()</div><div class="line">       .url(<span class="string">"http://publicobject.com/secrets/hellosecret.txt"</span>)</div><div class="line">       .build();</div><div class="line"></div><div class="line">   Response response = client.newCall(request).execute();</div><div class="line">   <span class="keyword">if</span> (!response.isSuccessful()) <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Unexpected code "</span> + response);</div><div class="line"></div><div class="line">   System.<span class="keyword">out</span>.println(response.<span class="keyword">body</span>().<span class="built_in">string</span>());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;为了避免验证失败出现的多次重试，你可以通过返回 null 来跳过。例如你可以跳过重试当你遇到这些证书被要求验证。<br><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (credential.<span class="keyword">equals</span>(response.request().<span class="keyword">header</span>(<span class="string">"Authorization"</span>))) &#123;</div><div class="line">   <span class="keyword">return</span> <span class="built_in">null</span>; <span class="comment">// If we already failed with these credentials, don't retry.</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>&emsp;你也可以通过设置重试次数限制来跳过重试请求。<br><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (responseCount(response) &gt;= <span class="number">3</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// If we've failed 3 times, give up.</span></div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>上述代码依赖 <em>responseCount()</em> 方法<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="built_in">int</span> responseCount(<span class="built_in">Response</span> <span class="built_in">response</span>) &#123;</div><div class="line">    <span class="built_in">int</span> result = <span class="number">1</span>;</div><div class="line">    <span class="keyword">while</span> ((<span class="built_in">response</span> = <span class="built_in">response</span>.priorResponse()) != <span class="literal">null</span>) &#123;</div><div class="line">      result++;</div><div class="line">    &#125;</div><div class="line">    return result;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2016/08/05/okhttp使用指南(四)/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2016/08/05/okhttp使用指南(五)/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title"></div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>






<div class="duoshuo">
	<!-- 多说评论框 start -->
	<div class="ds-thread" data-thread-key="okhttp使用指南(三)" data-title="OkHttp 使用指南(四)--Recipes" data-url="http://nortonahu.github.io/2016/08/05/okhttp使用指南(三)/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- 多说公共JS代码 end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Hong Yu
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js"></script>
<script src="/js/main.js"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>